{% extends "layouts/app_base.html" %}
{% load static %}

{% block title %}Portfolio - NepseSewa{% endblock %}

{% block extra_css %}
<style>
    /* Portfolio specific charts */
    .chart-wrap {
        height: 300px;
        position: relative;
    }

    #portfolioValueChart,
    #allocationChart {
        width: 100% !important;
        height: 100% !important;
        display: block;
    }

    .symbol-pill {
        font-weight: 900;
        letter-spacing: .2px;
    }

    /* Professional Activity List */
    .activity-item {
        background: rgba(255, 255, 255, 0.5);
        border-radius: 12px;
        padding: 12px 16px;
        margin-bottom: 8px;
        transition: all 0.3s ease;
        border: 1px solid rgba(0, 0, 0, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .activity-item:hover {
        background: #fff;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        border-color: var(--primary-light);
    }

    .activity-icon {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        margin-right: 12px;
    }

    .activity-icon.buy {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
    }

    .activity-icon.sell {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }

    .activity-details {
        flex-grow: 1;
    }

    .activity-title {
        font-weight: 800;
        font-size: 0.95rem;
        margin-bottom: 2px;
        color: #1a202c;
    }

    .activity-meta {
        font-size: 0.75rem;
        color: #718096;
        font-weight: 600;
    }

    .activity-time {
        text-align: right;
        font-size: 0.75rem;
        color: #a0aec0;
        font-weight: 600;
        min-width: 80px;
    }

    /* Refined Pagination */
    .pg-indicator {
        background: #f8fafc;
        padding: 6px 14px;
        border-radius: 10px;
        font-size: 0.8rem;
        font-weight: 800;
        color: #1a202c;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
    }

    .btn-pg {
        width: 38px;
        height: 38px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid #e2e8f0;
        background: #fff;
        color: #4a5568;
    }

    .btn-pg:hover:not(:disabled) {
        background: var(--primary);
        color: #fff;
        border-color: var(--primary);
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
    }

    .btn-pg:active:not(:disabled) {
        transform: scale(0.95);
    }

    .btn-pg.disabled,
    .btn-pg:disabled {
        background: #f1f5f9;
        color: #cbd5e0;
        border-color: #e2e8f0;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
    <div>
        <h4 class="mb-0" style="font-weight:900;">Your Portfolio</h4>
        <div class="text-muted" style="font-weight:700;">Holdings • Performance • Allocation</div>
    </div>
    <div class="d-flex align-items-center gap-2">
        <span class="chip" title="Last updated">
            <i class="fa-solid fa-clock"></i>
            <span id="portfolioAsOf">As of —</span>
        </span>
        <a href="{% url 'trade' %}" class="btn btn-success"
            style="border-radius:12px;font-weight:900;padding:.65rem 1rem;background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);border:none;">
            <i class="fas fa-plus me-2"></i>New Trade
        </a>
    </div>
</div>

<!-- Summary cards -->
<div class="row mb-3">
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(16,185,129,.10); color: var(--primary);">
                <i class="fas fa-wallet"></i>
            </div>
            <div>
                <div class="stat-label">Total Value</div>
                <div class="stat-value" id="sumTotalValue">Rs —</div>
                <div class="text-muted fw-bold" style="font-size:.85rem;">market value</div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(59,130,246,.10); color: var(--info);">
                <i class="fas fa-layer-group"></i>
            </div>
            <div>
                <div class="stat-label">Holdings</div>
                <div class="stat-value" id="sumHoldings">—</div>
                <div class="text-muted fw-bold" style="font-size:.85rem;">unique scrips</div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(245,158,11,.10); color: var(--warning);">
                <i class="fas fa-bolt"></i>
            </div>
            <div>
                <div class="stat-label">Today's P/L</div>
                <div class="stat-value" id="sumTodayPL">—</div>
                <div class="fw-bold" style="font-size:.85rem;" id="sumTodayPLPct">—</div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(239,68,68,.10); color: var(--danger);">
                <i class="fas fa-chart-line"></i>
            </div>
            <div>
                <div class="stat-label">Overall P/L</div>
                <div class="stat-value" id="sumOverallPL">—</div>
                <div class="fw-bold" style="font-size:.85rem;" id="sumOverallPLPct">—</div>
            </div>
        </div>
    </div>
</div>

<!-- Charts row -->
<div class="row">
    <div class="col-lg-8 mb-3">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title">Portfolio Value (Live)</h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-success" id="btnRange1D">1D</button>
                    <button class="btn btn-sm btn-outline-success" id="btnRange1W">1W</button>
                    <button class="btn btn-sm btn-outline-success" id="btnRange1M">1M</button>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-wrap">
                    <canvas id="portfolioValueChart"></canvas>
                </div>

                <div class="row text-center border-top pt-3 mt-3">
                    <div class="col-4">
                        <small class="text-muted">1 Day</small>
                        <div class="fw-bold" id="perf1d">—</div>
                    </div>
                    <div class="col-4">
                        <small class="text-muted">1 Week</small>
                        <div class="fw-bold" id="perf1w">—</div>
                    </div>
                    <div class="col-4">
                        <small class="text-muted">1 Month</small>
                        <div class="fw-bold" id="perf1m">—</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">Allocation</h5>
            </div>
            <div class="card-body">
                <div style="height: 300px;">
                    <canvas id="allocationChart"></canvas>
                </div>
                <div class="text-muted mt-3" style="font-weight:700;font-size:.9rem;">
                    Shows weight by market value per stock (Top 8).
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Holdings table + Activity -->
<div class="row">
    <div class="col-lg-8 mb-3">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title">Holdings</h5>
                <span class="chip" id="holdingsBadge">
                    <i class="fa-solid fa-circle-info"></i>
                    Live LTP applied
                </span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table mb-0">
                        <thead>
                            <tr>
                                <th class="ps-3">Symbol</th>
                                <th>Qty</th>
                                <th>Avg Buy</th>
                                <th>LTP</th>
                                <th>Value</th>
                                <th class="text-end pe-3">P/L</th>
                            </tr>
                        </thead>
                        <tbody id="holdingsTbody">
                            <tr>
                                <td colspan="6" class="text-center text-muted p-4">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4 mb-3">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="card-title">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'trade' %}" class="btn btn-success"
                        style="border-radius:12px;font-weight:900;background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);border:none;">
                        <i class="fas fa-exchange-alt me-2"></i>Trade
                    </a>
                    <a href="{% url 'market' %}" class="btn btn-outline-success"
                        style="border-radius:12px;font-weight:900;">
                        <i class="fas fa-chart-line me-2"></i>Market
                    </a>
                    <a href="{% url 'watchlist' %}" class="btn btn-outline-primary"
                        style="border-radius:12px;font-weight:900;">
                        <i class="fas fa-star me-2"></i>Watchlist
                    </a>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="card-title">Recent Activity</h5>
            </div>
            <div class="card-body">
                <div id="recentActivity" class="text-muted" style="font-weight:700;">
                    Connect this to your trade history API later.
                </div>
            </div>
        </div>
    </div>
</div>

<div class="text-muted mt-2" style="font-weight:700;font-size:.85rem;">
    Tip: You can compute P/L using (LTP - AvgBuy) * Qty. If you store buy price/qty per user in DB, this page can
    become fully live.
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/nepse-portfolio.js' %}"></script>
{% endblock %}