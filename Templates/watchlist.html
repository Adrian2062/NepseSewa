{% extends "layouts/app_base.html" %}
{% load static %}

{% block title %}Watchlist - NepseSewa{% endblock %}

{% block extra_css %}
<style>
  /* Watchlist Specific Styles */
  .mini-kpi {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1rem;
    flex: 1;
    min-width: 140px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .mini-kpi:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    border-color: var(--primary);
  }

  .mini-kpi.active {
    background: #f0f9ff;
    border-color: var(--primary);
    box-shadow: inset 0 0 0 2px rgba(59, 130, 246, 0.1);
  }

  .mini-kpi .label {
    font-size: .75rem;
    font-weight: 800;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: .5px;
  }

  .mini-kpi .value {
    font-size: 1.5rem;
    font-weight: 900;
    color: #111827;
    line-height: 1.2;
  }

  .signal-pill {
    padding: .25rem .6rem;
    border-radius: 6px;
    font-size: .7rem;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: .5px;
    display: inline-block;
  }

  .sig-buy {
    background: rgba(16, 185, 129, .15);
    color: var(--primary-dark);
  }

  .sig-sell {
    background: rgba(239, 68, 68, .15);
    color: #b91c1c;
  }

  .sig-hold {
    background: rgba(245, 158, 11, .15);
    color: #d97706;
  }

  .rec-card {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
    transition: transform .2s;
  }

  .rec-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, .05);
  }

  .rec-card .symbol {
    font-weight: 900;
    font-size: 1.1rem;
  }

  .rec-card .rec-meta {
    font-size: .8rem;
    color: var(--muted);
    font-weight: 700;
  }

  .rec-card .score {
    font-size: 1.5rem;
    font-weight: 900;
    color: var(--primary);
  }

  .soft-input {
    background: var(--light);
    border: 1px solid transparent;
    border-radius: 8px;
    padding: .5rem .8rem;
    font-weight: 700;
    color: #1f2937;
    outline: none;
  }

  .soft-input:focus {
    background: #fff;
    border-color: var(--primary);
  }

  .table-summary-info {
    background: #f8fafc;
    border-bottom: 1px solid var(--border);
    padding: 0.5rem 1rem;
    font-size: 0.8rem;
    font-weight: 700;
    color: var(--muted);
  }
</style>
{% endblock %}


{% block content %}
<div class="alert alert-warning border-0"
  style="border-radius:12px; background: rgba(245, 158, 11, .1); color: #92400e; font-weight: 700;">
  <i class="fas fa-exclamation-triangle me-2"></i>
  <strong>Academic Disclaimer:</strong> This recommendation system is developed for academic purposes only and should
  not be used for real financial trading.
</div>

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h4 class="mb-0" style="font-weight:900;">LSTM Stock Recommendations</h4>
    <div class="text-muted" style="font-weight:700;">AI-powered Buy/Sell signals for NEPSE</div>
  </div>
  <div class="d-flex gap-2">
    <button id="refreshAllBtn" class="btn btn-outline-primary" style="border-radius:12px; font-weight:900;">
      <i class="fas fa-sync-alt me-2"></i>Refresh All
    </button>
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addStockModal"
      style="border-radius:12px;font-weight:900;background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);border:none;">
      <i class="fas fa-plus me-2"></i>Add Stock
    </button>
  </div>
</div>

<!-- KPI Row -->
<div class="d-flex gap-3 mb-4 flex-wrap">
  <div class="mini-kpi" id="btnFilterAll" title="Show all stocks">
    <div class="label">Watchlist Count</div>
    <div class="value" id="kpiWatchCount">0</div>
  </div>
  <div class="mini-kpi" id="btnFilterBuy" title="Filter by Buy signals">
    <div class="label" style="color:var(--primary);">Buy Signals</div>
    <div class="value" style="color:var(--primary);" id="kpiBuyCount">0</div>
  </div>
  <div class="mini-kpi" id="btnFilterSell" title="Filter by Sell signals">
    <div class="label" style="color:var(--danger);">Sell Signals</div>
    <div class="value" style="color:var(--danger);" id="kpiSellCount">0</div>
  </div>
  <div class="mini-kpi" id="btnFilterHold" title="Filter by Hold signals">
    <div class="label" style="color:#d97706;">Hold Signals</div>
    <div class="value" style="color:#d97706;" id="kpiHoldCount">0</div>
  </div>
</div>

<div class="row">
  <!-- Main Watchlist Table -->
  <div class="col-lg-12 mb-4">
    <div class="card">
      <div class="card-header d-flex flex-wrap gap-2 align-items-center">
        <h5 class="card-title mb-0 flex-grow-1">Market Signals</h5>

        <!-- View Toggle -->
        <div class="btn-group me-3" role="group" aria-label="View Toggle">
          <input type="radio" class="btn-check" name="viewToggle" id="viewWatchlist" autocomplete="off" checked>
          <label class="btn btn-outline-primary btn-sm fw-bold" for="viewWatchlist">My Watchlist</label>

          <input type="radio" class="btn-check" name="viewToggle" id="viewAll" autocomplete="off">
          <label class="btn btn-outline-primary btn-sm fw-bold" for="viewAll">All Market</label>
        </div>

        <!-- Filters -->
        <input id="wlSearch" class="soft-input" placeholder="Search..." style="width:140px;">
        <select id="wlSignal" class="soft-input" style="width:120px;cursor:pointer;">
          <option value="">All Signals</option>
          <option value="1">Buy</option>
          <option value="-1">Sell</option>
          <option value="0">Hold</option>
        </select>
      </div>
      <div id="tableSummaryLabel" class="table-summary-info d-none">
        <!-- populated by JS -->
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table mb-0 align-middle">
            <thead>
              <tr>
                <th class="ps-3">Symbol</th>
                <th>Current Price</th>
                <th>Predicted (Next Day)</th>
                <th>Recommendation</th>
                <th>Signal</th>
                <th>Confidence (RMSE)</th>
                <th class="text-end pe-3">Action</th>
              </tr>
            </thead>
            <tbody id="watchlistBody">
              <!-- Dynamically populated by watchlist.js -->
              <tr>
                <td colspan="7" class="text-center py-5">
                  <div class="spinner-border text-primary" role="status"></div>
                  <div class="mt-2 text-muted fw-bold">Loading your watchlist...</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="card-footer d-flex justify-content-between align-items-center text-muted"
        style="font-size:.85rem;font-weight:700;">
        <span><i class="fas fa-info-circle me-1"></i> Predictions use sliding window (30 days) LSTM.</span>
        <span class="text-danger small">** Academic Project - Not Financial Advice **</span>
      </div>
    </div>
  </div>
</div>

<!-- Add Stock Modal -->
<div class="modal fade" id="addStockModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius:16px;border:1px solid var(--border);">
      <div class="modal-header">
        <h5 class="modal-title" style="font-weight:900;">Add Stock to Watchlist</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="addStockForm">
        <div class="modal-body">
          <label class="muted mb-2">Stock Symbol</label>
          <input id="stockSymbolInput" name="symbol" class="soft-input w-100" placeholder="e.g., NABIL, NICA, HDL"
            required />
          <div class="muted mt-3 small">Adding a stock will calculate its initial prediction (may take 5-10 seconds).
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success" id="addSubmitBtn">
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            <i class="fas fa-plus me-2"></i>Add to Watchlist
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/watchlist.js' %}?v={% now 'U' %}"></script>
{% endblock %}