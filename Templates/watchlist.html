{% extends "layouts/app_base.html" %}
{% load static %}

{% block title %}Watchlist - NepseSewa{% endblock %}

{% block extra_css %}
<style>
  /* Watchlist Specific Styles */
  /* Watchlist Overhaul - Professional Dashboard Styles */
  :root {
    --glass-bg: rgba(255, 255, 255, 0.7);
    --glass-border: rgba(255, 255, 255, 0.3);
    --card-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
  }

  .kpi-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .premium-kpi {
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 1.5rem;
    box-shadow: var(--card-shadow);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    position: relative;
    overflow: hidden;
  }

  .premium-kpi:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.12);
    border-color: var(--primary);
  }

  .premium-kpi.active {
    background: linear-gradient(135deg, #f0f7ff 0%, #e0efff 100%);
    border-color: var(--primary);
  }

  .kpi-icon {
    position: absolute;
    right: -10px;
    bottom: -10px;
    font-size: 4rem;
    opacity: 0.05;
    transform: rotate(-15deg);
  }

  .kpi-label {
    font-size: 0.75rem;
    font-weight: 800;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 0.5rem;
    display: block;
  }

  .kpi-value {
    font-size: 2rem;
    font-weight: 900;
    color: #1a202c;
    line-height: 1;
  }

  .signal-pill {
    padding: .25rem .6rem;
    border-radius: 6px;
    font-size: .7rem;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: .5px;
    display: inline-block;
  }

  .sig-buy {
    background: rgba(16, 185, 129, .15);
    color: var(--primary-dark);
  }

  .sig-sell {
    background: rgba(239, 68, 68, .15);
    color: #b91c1c;
  }

  /* Table Enhancements */
  .stock-table-card {
    border-radius: 24px;
    border: none;
    box-shadow: var(--card-shadow);
    overflow: hidden;
  }

  .table thead th {
    background: #f8fafc;
    text-transform: uppercase;
    font-size: 0.7rem;
    font-weight: 800;
    letter-spacing: 0.5px;
    color: #64748b;
    padding: 1.25rem 1rem;
    border-bottom: 1px solid #e2e8f0;
  }

  .table tbody tr {
    transition: background 0.2s;
  }

  .table tbody tr:hover {
    background-color: #f1f5f9 !important;
  }

  .table td {
    padding: 1.25rem 1rem;
    border-bottom: 1px solid #f1f5f9;
  }

  .symbol-tag {
    font-size: 1rem;
    font-weight: 900;
    color: #1e293b;
    display: block;
  }

  /* Badges & Signals */
  .signal-pill {
    padding: 0.4rem 0.8rem;
    border-radius: 30px;
    font-size: 0.75rem;
    font-weight: 900;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    text-transform: uppercase;
  }

  .sig-buy {
    background: #ecfdf5;
    color: #059669;
    border: 1px solid #10b98140;
  }

  .sig-sell {
    background: #fef2f2;
    color: #dc2626;
    border: 1px solid #ef444440;
  }

  .sig-hold {
    background: #fffbeb;
    color: #d97706;
    border: 1px solid #f59e0b40;
  }

  .trend-badge {
    padding: 0.25rem 0.6rem;
    border-radius: 8px;
    font-size: 0.65rem;
    font-weight: 800;
    text-transform: uppercase;
  }

  .trend-bullish {
    background: #dcfce7;
    color: #166534;
  }

  .trend-bearish {
    background: #fee2e2;
    color: #991b1b;
  }

  .trend-neutral {
    background: #f1f5f9;
    color: #475569;
  }

  /* Level Tags */
  .level-group {
    display: flex;
    gap: 0.75rem;
  }

  .level-item {
    display: flex;
    flex-direction: column;
    background: #f8fafc;
    padding: 0.35rem 0.6rem;
    border-radius: 10px;
    border: 1px solid #e2e8f0;
    min-width: 85px;
  }

  .level-title {
    font-size: 0.6rem;
    font-weight: 800;
    text-transform: uppercase;
    color: #64748b;
    margin-bottom: 2px;
  }

  .level-price {
    font-size: 0.85rem;
    font-weight: 800;
    color: #1e293b;
  }

  .level-item.target {
    background: #f0fdf4;
    border-color: #bbf7d0;
  }

  .level-item.target .level-price {
    color: #166534;
  }

  .level-item.sl {
    background: #fff1f2;
    border-color: #fecdd3;
  }

  .level-item.sl .level-price {
    color: #991b1b;
  }

  /* Highlight rows */
  .row-buy {
    background-color: rgba(16, 185, 129, 0.03) !important;
  }

  .row-sell {
    background-color: rgba(239, 68, 68, 0.03) !important;
  }

  .soft-input {
    background: #f1f5f9;
    border: 2px solid transparent;
    border-radius: 12px;
    padding: 0.6rem 1rem;
    font-weight: 700;
    color: #1e293b;
    outline: none;
    transition: all 0.2s;
  }

  .soft-input:focus {
    background: #fff;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
  }

  .table-summary-info {
    background: #f8fafc;
    border-bottom: 1px solid var(--border);
    padding: 0.5rem 1rem;
    font-size: 0.8rem;
    font-weight: 700;
    color: var(--muted);
  }

  /* Premium Lock Styles */
  .premium-lock-container {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(37, 99, 235, 0.1) 100%);
    border-radius: 30px;
    padding: 4rem 2rem;
    text-align: center;
    border: 1px dashed #3b82f640;
    margin: 2rem 0;
    backdrop-filter: blur(10px);
  }

  .lock-icon-wrap {
    width: 100px;
    height: 100px;
    background: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 2rem;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    font-size: 2.5rem;
    color: var(--primary);
  }

  .premium-unlock-btn {
    background: linear-gradient(135deg, #0d6efd 0%, #0dcaf0 100%);
    color: white;
    font-weight: 900;
    padding: 1rem 2.5rem;
    border-radius: 15px;
    border: none;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    display: inline-block;
    text-decoration: none;
    margin-top: 1.5rem;
    box-shadow: 0 10px 20px rgba(13, 110, 253, 0.3);
  }

  .premium-unlock-btn:hover {
    transform: scale(1.05) translateY(-5px);
    box-shadow: 0 15px 30px rgba(13, 110, 253, 0.4);
    color: white;
  }
</style>
{% endblock %}


{% block content %}
<div class="alert alert-warning border-0"
  style="border-radius:12px; background: rgba(245, 158, 11, .1); color: #92400e; font-weight: 700;">
  <i class="fas fa-exclamation-triangle me-2"></i>
  <strong>Academic Disclaimer:</strong> This recommendation system is developed for academic purposes only and should
  not be used for real financial trading.
</div>

{% if user.subscription and user.subscription.plan.tier >= 2 %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h4 class="mb-0" style="font-weight:900;">LSTM Stock Recommendations</h4>
    <div class="text-muted" style="font-weight:700;">AI-powered Buy/Sell signals for NEPSE</div>
  </div>
  <div class="d-flex gap-2">
    <!-- Automated daily refresh - manual button removed -->
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addStockModal"
      style="border-radius:12px;font-weight:900;background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);border:none;">
      <i class="fas fa-plus me-2"></i>Add Stock
    </button>
  </div>
</div>

<!-- KPI Section -->
<div class="kpi-container">
  <div class="premium-kpi" id="btnFilterAll" title="Total Watchlist">
    <i class="fas fa-list-ul kpi-icon"></i>
    <span class="kpi-label">Market Scope</span>
    <div class="kpi-value" id="kpiWatchCount">0</div>
  </div>
  <div class="premium-kpi" id="btnFilterBuy" title="Buying Opportunities">
    <i class="fas fa-arrow-trend-up kpi-icon"></i>
    <span class="kpi-label" style="color:#059669;">Buy Signals</span>
    <div class="kpi-value" style="color:#059669;" id="kpiBuyCount">0</div>
  </div>
  <div class="premium-kpi" id="btnFilterSell" title="Selling Indicators">
    <i class="fas fa-arrow-trend-down kpi-icon"></i>
    <span class="kpi-label" style="color:#dc2626;">Sell Signals</span>
    <div class="kpi-value" style="color:#dc2626;" id="kpiSellCount">0</div>
  </div>
  <div class="premium-kpi" id="btnFilterHold" title="Neutral Performance">
    <i class="fas fa-minus kpi-icon"></i>
    <span class="kpi-label" style="color:#d97706;">Hold</span>
    <div class="kpi-value" style="color:#d97706;" id="kpiHoldCount">0</div>
  </div>
  <div class="premium-kpi ms-auto" style="border-color: #cbd5e1; background: #fff; cursor: default;">
    <span class="kpi-label">Prediction Engine</span>
    <div class="kpi-value" style="font-size: 1.1rem; color: #475569;">Daily @ 3:30 PM</div>
    <div class="small fw-bold text-muted mt-1" style="font-size: 0.6rem;">LSTM Neural Network</div>
  </div>
</div>

<div class="row">
  <!-- Main Watchlist Table -->
  <div class="col-lg-12 mb-4">
    <div class="card stock-table-card">
      <div class="card-header bg-white py-3 d-flex flex-wrap gap-2 align-items-center">
        <h5 class="card-title mb-0 flex-grow-1" style="font-weight: 900; color: #1e293b;">
          Market Signals <span class="badge bg-primary ms-2" style="font-size: 0.6rem; vertical-align: middle;">AI
            LIVE</span>
        </h5>

        <!-- View Toggle -->
        <div class="btn-group me-3" role="group" aria-label="View Toggle">
          <input type="radio" class="btn-check" name="viewToggle" id="viewWatchlist" autocomplete="off" checked>
          <label class="btn btn-outline-primary btn-sm fw-bold" for="viewWatchlist">My Watchlist</label>

          <input type="radio" class="btn-check" name="viewToggle" id="viewAll" autocomplete="off">
          <label class="btn btn-outline-primary btn-sm fw-bold" for="viewAll">All Market</label>
        </div>

        <!-- Filters -->
        <input id="wlSearch" class="soft-input" placeholder="Search..." style="width:140px;">
        <select id="wlSignal" class="soft-input" style="width:120px;cursor:pointer;">
          <option value="">All Signals</option>
          <option value="1">Buy</option>
          <option value="-1">Sell</option>
          <option value="0">Hold</option>
        </select>
      </div>
      <div id="tableSummaryLabel" class="table-summary-info d-none">
        <!-- populated by JS -->
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table mb-0 align-middle">
            <thead>
              <tr>
                <th class="ps-3">Symbol</th>
                <th>Current Price</th>
                <th>Predicted Change</th>
                <th>Trend</th>
                <th>Signal</th>
                <th>Levels (Entry / Target / SL)</th>
                <th>Confidence</th>
                <th class="text-end pe-3">Action</th>
              </tr>
            </thead>
            <tbody id="watchlistBody">
              <!-- Dynamically populated by watchlist.js -->
              <tr>
                <td colspan="7" class="text-center py-5">
                  <div class="spinner-border text-primary" role="status"></div>
                  <div class="mt-2 text-muted fw-bold">Loading your watchlist...</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="card-footer d-flex justify-content-between align-items-center text-muted"
        style="font-size:.85rem;font-weight:700;">
        <span><i class="fas fa-info-circle me-1"></i> Predictions use sliding window (30 days) LSTM.</span>
        <span class="text-danger small">** Academic Project - Not Financial Advice **</span>
      </div>
    </div>
  </div>
</div>
{% else %}
<!-- Premium Conversion UI -->
<div class="premium-lock-container shadow-sm">
  <div class="lock-icon-wrap">
    <i class="fas fa-brain"></i>
  </div>
  <h2 style="font-weight: 900; color: #1e293b; margin-bottom: 1rem;">Unlock Premium Intelligence</h2>
  <p class="text-muted mx-auto mb-4" style="max-width: 600px; font-weight: 700; font-size: 1.1rem; line-height: 1.6;">
    Our LSTM Neural Network recommendation model is reserved for Premium and Gold subscribers. Upgrade now to access
    real-time AI signals, target levels, and professional market insights.
  </p>

  <div class="row g-4 justify-content-center mb-4">
    <div class="col-md-3">
      <div class="p-3 bg-white rounded-4 border">
        <i class="fas fa-microchip mb-2 text-primary"></i>
        <h6 class="fw-bold mb-0">LSTM AI Model</h6>
      </div>
    </div>
    <div class="col-md-3">
      <div class="p-3 bg-white rounded-4 border">
        <i class="fas fa-bullseye mb-2 text-success"></i>
        <h6 class="fw-bold mb-0">Target Levels</h6>
      </div>
    </div>
    <div class="col-md-3">
      <div class="p-3 bg-white rounded-4 border">
        <i class="fas fa-shield-halved mb-2 text-danger"></i>
        <h6 class="fw-bold mb-0">Risk Management</h6>
      </div>
    </div>
  </div>

  <a href="{% url 'pricing' %}" class="premium-unlock-btn">
    <i class="fas fa-crown me-2"></i>Upgrade to Paid Plan
  </a>
</div>
{% endif %}

<!-- Add Stock Modal -->
<div class="modal fade" id="addStockModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius:16px;border:1px solid var(--border);">
      <div class="modal-header">
        <h5 class="modal-title" style="font-weight:900;">Add Stock to Watchlist</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="addStockForm">
        <div class="modal-body">
          <label class="muted mb-2">Stock Symbol</label>
          <input id="stockSymbolInput" name="symbol" class="soft-input w-100" placeholder="e.g., NABIL, NICA, HDL"
            required />
          <div class="muted mt-3 small">Adding a stock will calculate its initial prediction (may take 5-10 seconds).
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success" id="addSubmitBtn">
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            <i class="fas fa-plus me-2"></i>Add to Watchlist
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/watchlist.js' %}?v={% now 'U' %}"></script>
{% endblock %}