{% extends "layouts/app_base.html" %}
{% load static %}

{% block title %}Dashboard - NepseSewa{% endblock %}

{% block content %}
<!-- Ticker -->
<div class="news-ticker">
    <span class="ticker-label" id="tickerLabel"><i class="fas fa-circle"></i>Live</span>
    <span class="ticker-asof" id="tickerAsOf">As of Loading...</span>
    <div class="ticker-wrapper">
        <div class="ticker-content" id="tickerContent"></div>
    </div>
</div>

<!-- Welcome Banner -->
<div class="welcome-banner">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h4 class="mb-2" style="font-weight:800;">Welcome back, {{ request.user.first_name }}! ðŸ‘‹</h4>
            <p class="mb-0" style="opacity:.92;">Monitor your portfolio and explore the market.</p>
        </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
            <div class="virtual-balance">
                <div style="font-size:.75rem;font-weight:800;opacity:.9;letter-spacing:.8px;">VIRTUAL BALANCE</div>
                <div style="font-size:1.4rem;font-weight:900;">Rs {{ request.user.virtual_balance|floatformat:2 }}</div>
                <small class="text-white-50" id="vbHint">Live market updates</small>
            </div>
        </div>
    </div>
</div>

<!-- Stats -->
<div class="row mb-3">
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(16,185,129,.10);">
                <i class="fas fa-wallet" style="color: var(--primary);"></i>
            </div>
            <div>
                <div class="stat-label">Total Portfolio</div>
                <div class="stat-value" id="dashboardPortfolioValue">Rs {{ request.user.portfolio_value|floatformat:0 }}
                </div>
                <div class="fw-bold" style="font-size:.85rem;color: var(--muted);" id="dashboardPortfolioPercent">user
                    value</div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(59,130,246,.10);">
                <i class="fas fa-chart-line" style="color: var(--info);"></i>
            </div>
            <div>
                <div class="stat-label">Today's Profit</div>
                <div class="stat-value" id="dashboardTodayProfit">â€”</div>
                <div class="fw-bold" style="font-size:.85rem;" id="dashboardTodayProfitPct">loading...</div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(245,158,11,.10);">
                <i class="fas fa-star" style="color: var(--warning);"></i>
            </div>
            <div>
                <div class="stat-label">Active Stocks</div>
                <div class="stat-value" id="activeStocks">â€”</div>
                <div class="fw-bold" style="font-size:.85rem;color: var(--muted);">from live data</div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(156,39,176,.10);">
                <i class="fas fa-trophy" style="color: #9c27b0;"></i>
            </div>
            <div>
                <div class="stat-label">Your Rank</div>
                <div class="stat-value" id="dashboardRank">â€”</div>
                <div class="fw-bold" style="font-size:.85rem;color: var(--muted);" id="dashboardRankTotal">of â€” users
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Performance + right -->
<div class="row">
    <div class="col-lg-8 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">Portfolio Performance</h5>
            </div>
            <div class="card-body">
                <div class="chart-wrap"><canvas id="portfolioChart"></canvas></div>

                <div class="row text-center border-top pt-3 mt-3">
                    <div class="col-4">
                        <small class="text-muted">1 Day</small>
                        <div class="fw-bold" id="dashboardPerf1d">â€”</div>
                    </div>
                    <div class="col-4">
                        <small class="text-muted">1 Week</small>
                        <div class="fw-bold" id="dashboardPerf1w">â€”</div>
                    </div>
                    <div class="col-4">
                        <small class="text-muted">1 Month</small>
                        <div class="fw-bold" id="dashboardPerf1m">â€”</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4 mb-3">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="card-title">Recent Activity</h5>
            </div>
            <div class="card-body" id="dashboardRecentActivity">
                <div class="text-muted">Loading activity...</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="card-title">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'trade' %}" class="btn btn-success">
                        <i class="fas fa-exchange-alt me-2"></i>Trade Stocks
                    </a>
                    <a href="{% url 'market' %}" class="btn btn-outline-success">
                        <i class="fas fa-chart-line me-2"></i>View Market
                    </a>
                    <a href="{% url 'learn' %}" class="btn btn-outline-primary">
                        <i class="fas fa-graduation-cap me-2"></i>Learn Trading
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Market Overview -->
<div class="row">
    <!-- Top Gainers -->
    <div class="col-lg-4 mb-3">
        <div class="card market-card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title text-success">Top Gainers</h5>
                <small><i class="fas fa-arrow-up"></i> Today</small>
            </div>
            <div class="card-body p-0">
                {% for item in top_gainers %}
                <div class="market-item">
                    <div class="market-symbol">{{ item.symbol }}</div>
                    <div class="text-end">
                        <div class="market-price">Rs {{ item.ltp|floatformat:2 }}</div>
                        <div class="market-change text-success">+{{ item.change_pct|floatformat:2 }}%</div>
                    </div>
                </div>
                {% empty %}
                <div class="p-3 text-muted text-center">No data available</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Top Losers -->
    <div class="col-lg-4 mb-3">
        <div class="card market-card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title text-danger">Top Losers</h5>
                <small><i class="fas fa-arrow-down"></i> Today</small>
            </div>
            <div class="card-body p-0">
                {% for item in top_losers %}
                <div class="market-item">
                    <div class="market-symbol">{{ item.symbol }}</div>
                    <div class="text-end">
                        <div class="market-price">Rs {{ item.ltp|floatformat:2 }}</div>
                        <div class="market-change text-danger">{{ item.change_pct|floatformat:2 }}%</div>
                    </div>
                </div>
                {% empty %}
                <div class="p-3 text-muted text-center">No data available</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Active Stocks (By Turnover) -->
    <div class="col-lg-4 mb-3">
        <div class="card market-card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title text-primary">Top Active</h5>
                <small><i class="fas fa-bolt"></i> Turnover</small>
            </div>
            <div class="card-body p-0">
                {% for item in top_turnover %}
                <div class="market-item">
                    <div class="market-symbol">{{ item.symbol }}</div>
                    <div class="text-end">
                        <div class="market-price">Rs {{ item.ltp|floatformat:2 }}</div>
                        <div
                            class="market-change {% if item.change_pct >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {% if item.change_pct >= 0 %}+{% endif %}{{ item.change_pct|floatformat:2 }}%
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="p-3 text-muted text-center">No data available</div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Watchlist Preview (Static Example) -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title">My Watchlist</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-3">Symbol</th>
                        <th>Name</th>
                        <th>Price</th>
                        <th>Change</th>
                        <th class="text-end pe-3">Action</th>
                    </tr>
                </thead>
                <tbody id="dashboardWatchlistTbody">
                    <tr>
                        <td colspan="5" class="text-center p-4 text-muted">Loading watchlist...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/dashboard.js' %}"></script>
{% endblock %}