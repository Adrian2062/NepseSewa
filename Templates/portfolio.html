{% extends "layouts/app_base.html" %}
{% load static %}

{% block title %}Portfolio - NepseSewa{% endblock %}

{% block extra_css %}
<style>
    /* Portfolio specific charts */
    .chart-wrap {
        height: 300px;
        position: relative;
    }

    #portfolioValueChart,
    #allocationChart {
        width: 100% !important;
        height: 100% !important;
        display: block;
    }

    .symbol-pill {
        font-weight: 900;
        letter-spacing: .2px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
    <div>
        <h4 class="mb-0" style="font-weight:900;">Your Portfolio</h4>
        <div class="text-muted" style="font-weight:700;">Holdings • Performance • Allocation</div>
    </div>
    <div class="d-flex align-items-center gap-2">
        <span class="chip" title="Last updated">
            <i class="fa-solid fa-clock"></i>
            <span id="portfolioAsOf">As of —</span>
        </span>
        <a href="{% url 'trade' %}" class="btn btn-success"
            style="border-radius:12px;font-weight:900;padding:.65rem 1rem;background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);border:none;">
            <i class="fas fa-plus me-2"></i>New Trade
        </a>
    </div>
</div>

<!-- Summary cards -->
<div class="row mb-3">
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(16,185,129,.10); color: var(--primary);">
                <i class="fas fa-wallet"></i>
            </div>
            <div>
                <div class="stat-label">Total Value</div>
                <div class="stat-value" id="sumTotalValue">Rs —</div>
                <div class="text-muted fw-bold" style="font-size:.85rem;">market value</div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(59,130,246,.10); color: var(--info);">
                <i class="fas fa-layer-group"></i>
            </div>
            <div>
                <div class="stat-label">Holdings</div>
                <div class="stat-value" id="sumHoldings">—</div>
                <div class="text-muted fw-bold" style="font-size:.85rem;">unique scrips</div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(245,158,11,.10); color: var(--warning);">
                <i class="fas fa-bolt"></i>
            </div>
            <div>
                <div class="stat-label">Today's P/L</div>
                <div class="stat-value" id="sumTodayPL">—</div>
                <div class="fw-bold" style="font-size:.85rem;" id="sumTodayPLPct">—</div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(239,68,68,.10); color: var(--danger);">
                <i class="fas fa-chart-line"></i>
            </div>
            <div>
                <div class="stat-label">Overall P/L</div>
                <div class="stat-value" id="sumOverallPL">—</div>
                <div class="fw-bold" style="font-size:.85rem;" id="sumOverallPLPct">—</div>
            </div>
        </div>
    </div>
</div>

<!-- Charts row -->
<div class="row">
    <div class="col-lg-8 mb-3">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title">Portfolio Value (Live)</h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-success" id="btnRange1D">1D</button>
                    <button class="btn btn-sm btn-outline-success" id="btnRange1W">1W</button>
                    <button class="btn btn-sm btn-outline-success" id="btnRange1M">1M</button>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-wrap">
                    <canvas id="portfolioValueChart"></canvas>
                </div>

                <div class="row text-center border-top pt-3 mt-3">
                    <div class="col-4">
                        <small class="text-muted">1 Day</small>
                        <div class="fw-bold" id="perf1d">—</div>
                    </div>
                    <div class="col-4">
                        <small class="text-muted">1 Week</small>
                        <div class="fw-bold" id="perf1w">—</div>
                    </div>
                    <div class="col-4">
                        <small class="text-muted">1 Month</small>
                        <div class="fw-bold" id="perf1m">—</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">Allocation</h5>
            </div>
            <div class="card-body">
                <div style="height: 300px;">
                    <canvas id="allocationChart"></canvas>
                </div>
                <div class="text-muted mt-3" style="font-weight:700;font-size:.9rem;">
                    Shows weight by market value per stock (Top 8).
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Holdings table + Activity -->
<div class="row">
    <div class="col-lg-8 mb-3">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title">Holdings</h5>
                <span class="chip" id="holdingsBadge">
                    <i class="fa-solid fa-circle-info"></i>
                    Live LTP applied
                </span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table mb-0">
                        <thead>
                            <tr>
                                <th class="ps-3">Symbol</th>
                                <th>Qty</th>
                                <th>Avg Buy</th>
                                <th>LTP</th>
                                <th>Value</th>
                                <th class="text-end pe-3">P/L</th>
                            </tr>
                        </thead>
                        <tbody id="holdingsTbody">
                            <tr>
                                <td colspan="6" class="text-center text-muted p-4">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4 mb-3">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="card-title">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'trade' %}" class="btn btn-success"
                        style="border-radius:12px;font-weight:900;background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);border:none;">
                        <i class="fas fa-exchange-alt me-2"></i>Trade
                    </a>
                    <a href="{% url 'market' %}" class="btn btn-outline-success"
                        style="border-radius:12px;font-weight:900;">
                        <i class="fas fa-chart-line me-2"></i>Market
                    </a>
                    <a href="{% url 'watchlist' %}" class="btn btn-outline-primary"
                        style="border-radius:12px;font-weight:900;">
                        <i class="fas fa-star me-2"></i>Watchlist
                    </a>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="card-title">Recent Activity</h5>
            </div>
            <div class="card-body">
                <div id="recentActivity" class="text-muted" style="font-weight:700;">
                    Connect this to your trade history API later.
                </div>
            </div>
        </div>
    </div>
</div>

<div class="text-muted mt-2" style="font-weight:700;font-size:.85rem;">
    Tip: You can compute P/L using (LTP - AvgBuy) * Qty. If you store buy price/qty per user in DB, this page can
    become fully live.
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/nepse-portfolio.js' %}"></script>
{% endblock %}